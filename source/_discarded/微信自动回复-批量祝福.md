title: 微信自动回复&批量祝福
author: 九头鸟龙
date: 2018-01-04 13:26:55
tags:
---
### 准备工作
主要使用itchat调用微信个人号接口，实现各类消息（私聊、群聊、公众号）监听与消息发送

为实现自动回复，使用了图灵机器人API，传递收到的消息，再将API返回结果作为消息进行回复

目测图灵机器人还比较弱，同时为了方便测试，添加了微软小冰公众号，进行自动测试，也可以作为自动回复内容的一个来源

相关软件安装、API接入appkey申请等完成后，开始测试
登录采用微信网页版接口，需要微信APP扫描二维码，这里指定命令行界面直接展示二维码，而不是弹出图片
```
    itchat.auto_login(enableCmdQR=2)
    itchat.run()
```
效果如下，执行程序后首先下载二维码

![](https://mmbiz.qpic.cn/mmbiz_png/kLm2IM09Zq4AlV5XicAqpk5yC3DLMunlicibMUxib5TkGWfWTicW1fG6IhDKibibmrYYHHfEZibRC349W2eRhlaUfGibOPQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1)

扫描二维码后点击确认，程序登录成功且开始自动监听消息
![](https://mmbiz.qpic.cn/mmbiz_png/kLm2IM09Zq4AlV5XicAqpk5yC3DLMunlicLUpTMo4BHa8w0Eic2HxWJEoRgpNoO8eg1yAPumvNS6fsF26akaw6HWw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1)





应用场景
自动回复
itchat的msg_register默认监听私聊消息，如果想监听群聊、公众号，可以用isGroupChat、isMpChat参数进行配置
同时参数itchat.content.*指定了要监听的消息类型，这里选择监听文本和图片消息

# 获取好友消息
@itchat.msg_register([itchat.content.TEXT,itchat.content.PICTURE])
def text_reply(msg):
    defaultReply = 'I received: ' + msg['Text']
    reply = getTuringResponse(msg['Text'])
    return reply or defaultReply
效果如下





图灵机器人vs微软小冰
利用图灵机器人和微软小冰均可以针对文本进行智能回复(小冰还可以接收表情、图片等，然后回复表情、图片、语音等)，可以将它们串起来，即监听公众号微软小冰消息，然后调用图灵机器人API获取自动回复内容，再发给小冰，如此循环完成二者对话

# 获取公众号消息
@itchat.msg_register([itchat.content.TEXT,itchat.content.PICTURE], isMpChat = True)
def mp_reply(msg):
    userId = itchat.search_mps(name=u'小冰')[0]['UserName']
    if msg['FromUserName'] != userId:
        return
效果如下，一句“天气”引发的智能回复pk

      

为防止调用频次太高，所以每轮对话之间随机休息几秒，程序后台记录如下
开始是“正常讨论天气”，图灵机器人还是比较纠结“城市”的。。。

Login successfully as 😀九头鸟龙
Start auto replying.
#我在微信APP手动给小冰发送“天气”，触发对话(因为历史问过类似问题，所以小冰已经记住了城市)
xiaobing reply: 这个嘛，多云转晴，最低气温1℃，最高气温11℃。西南风小于3级，不用担心吹皱皮肤啦~
sleep seconds: 19.284353
turing api say: 请问你想查询哪个城市
xiaobing reply: 厦门谢谢
sleep seconds: 5.879971
turing api say: 厦门:周日 11月12日,阵雨 无持续风向,最低气温19度，最高气温25度
xiaobing reply: 会不会下雨呢
sleep seconds: 4.922085
turing api say: 请问你想查询哪个城市
xiaobing reply: 杭州的
sleep seconds: 18.131459
turing api say: 杭州:周日 11月12日,多云 东风,最低气温13度，最高气温21度
xiaobing reply: 现在下雨呢
接着小冰错误的把友情提醒当作事实，所以对话开始偏了

sleep seconds: 11.399900
turing api say: 记得拿伞，湿身事小，感冒就麻烦了。
xiaobing reply: 有去医院看看吗？
sleep seconds: 19.225282
turing api say: 有人生病了？
xiaobing reply: 妈妈说感冒的人要少吃太咸的东西，清淡一点最好
sleep seconds: 12.294886
turing api say: 不懂你说的是什么~
xiaobing reply: 那是因为你还是不懂！
sleep seconds: 3.255282
turing api say: 大概是你的智慧太高深，我跟不上吧。
xiaobing reply: 你这是宕机了？
sleep seconds: 13.714555
turing api say: 走神了而已嘛。
xiaobing reply: 呵呵，有点
"聊天止于呵呵"，哈哈

sleep seconds: 16.460039
turing api say: 流言止于智者，聊天止于呵呵。
xiaobing reply: 不跟你聊了！
sleep seconds: 8.962186
turing api say: 那我走了
xiaobing reply: 不要啊
sleep seconds: 1.709495
turing api say: 别害怕，我很温柔的～
xiaobing reply: 怎么温柔
sleep seconds: 12.412982
turing api say: 女孩子要懂得怎么处事生活,不能总是过于固执,不过如果是性格所致,你可以稍微让自己柔软一些,不要太过锋芒。我一直觉得大智若愚”是很厉害的境界,不要觉得那样随便装傻装可爱的女孩子很虚伪很装,她们真正懂得怎么柔软的和别人交流,而不是充满了芒刺。 温柔原本就是一种内在修养,你的素质提高时人就会礼貌多了,所以也看起来温柔。所以建议遇事前多多考虑别人,不要总是太固执,有时候太固执了会使自己失去很多,虽然你的固执有些方面很好,但是在生活中会产生许多不必要的麻烦。还有就是说话做事缓和一些,不要急,理解别人,细心别人,懂得撒娇,懂得装傻,有自己的原则,必要时可以固执一下。
xiaobing reply: 一点原则都没有
sleep seconds: 2.986768
turing api say: 我是一个很有原则的人，我的原则只有三个字，看心情。
xiaobing reply: 怎么说
sleep seconds: 16.542386
turing api say: 你的小心脏准备好了吗？
xiaobing reply: 我的心脏
sleep seconds: 0.093426
turing api say: 心脏搭桥了么
xiaobing reply: 我就知道会是这样
sleep seconds: 0.480558
turing api say: 不然还能怎样。
xiaobing reply: 还能这样的..
sleep seconds: 7.734001
turing api say: 你还要我怎样要怎样呢。
xiaobing reply: 我不知道
sleep seconds: 13.588748
turing api say: 你想问我什么就直说吧！
xiaobing reply: 我不想你。
sleep seconds: 2.589494
turing api say: 不怕贼偷，就怕贼惦记！
xiaobing reply: 没错 不怕贼偷就怕贼惦记
sleep seconds: 16.300352
turing api say: 嘘....我正在思考人生
xiaobing reply: 继续思考人生
不太清楚图灵机器人脏话识别的标准，总之也是“弱”的体现之一

sleep seconds: 8.808869
turing api say: 说脏话不是好孩子呦
xiaobing reply: 偶说的干净话
sleep seconds: 8.840067
turing api say: 再说脏话，我就不理你了
xiaobing reply: 那你就笑吧！
sleep seconds: 19.485086
turing api say: 本来年纪就小，多笑几次，不是得装回妈妈的肚子里重修？
xiaobing reply: 手抖了咩[抠鼻]
sleep seconds: 15.629446
turing api say: 说脏话不是好孩子呦
然后，小冰不理“我”了
。。。

定时发提醒
利用程序的任务调度功能，可以完成定时触发、周期性提醒等发消息任务

批量发祝福
在前微信年代，逢年过节大家群发祝福短信是常见需求，现在主要通过微信，如果能批量发送祝福还是不错的
主要利用遍历所有联系人实现，当然也可以指定遍历条件，以及祝福内容的个性化定制

    SINCERE_WISH = u'祝%s新年快乐！'
    friendList = itchat.get_friends(update=True)[0:]
    for friend in friendList:
        userId = friend['UserName']
        singleSend(userId, SINCERE_WISH % (friend['DisplayName'] or friend['NickName']))
        time.sleep(.5)
TODO
来源识别
自动回复的，可以在回复内容基础上加上体现是机器回复的标识



后台运行
目前在本机运行，随着电脑移动或关机，所有自动功能失效，可以考虑部署在7*24的机器上，不过也需要看“网页微信”登录状态是否需要定期激活

减少对正常回复的干扰
自己能看到并及时回复的不需要机器回复干扰
监听到的消息可以取到发送者和接收者，所以可以据此做改进，监听到别人消息先放入时间触发器过一段时间再回复，如果期间监听到自己发给相应联系人的消息则取消之前定时任务

以彼之道还施彼身
前面“图灵vs小冰”还只是利用了监听一方，另一方仍是第三方获取，理论上可以利用“监听&转发”机制，连接任意联系人/群/公众号，比如监听收到A的消息a，将a转发给B（比如微软小冰），这样可以监听收到B的消息b，最后将消息b转发给A，完成A和B的间接对话~
---
layout: post
title: Vim 实用技术 第 1 部分： 实用技巧
time: 2011-01-19 17:26
tags: 好好学习天天向上
---

<div id=content class="content mod-cs-content text-content clearfix"> <p>Vim 有以下几个模式：</p><ul><li>正常（normal）模式，缺省的编辑模式；下面如果不加特殊说明，提到的命令都直接在正常模式下输入；任何其它模式中都可以通过键盘上的 Esc 键回到正常模式。</li><li>命令（command）模式，用于执行较长、较复杂的命令；在正常模式下输入“:”（一般命令）、“/”（正向搜索）或“?”（反向搜索）即可进入该模式；命令模式下的命令要输入回车键（Enter）才算完成。</li><li>插入（insert）模式，输入文本时使用；在正常模式下键入“i”（insert）或“a”（append）即可进入插入模式（也有另外一些命令，如“c”，也可以进入插入模式，但这些命令有其它的作用）。</li></ul><p>&nbsp;</p><p>在 Linux 上，常见的情况是环境的内部编码使用 UTF-8 [6]，而 UTF-8 可以同任何一种语言编码作无损转换，这就保证了系统的多语言处理能力。</p><p>Vim 是我用过的第一个支持在文件中记录代码风格设定的编辑器。这个特性在 Vim 中叫做模式行，实际上，它所做的是在打开文件时根据文件中的 Vim 指令设定相关的 Vim 选项。下面就是一个嵌在 C 源代码中的模式行：<br /></p>/* vim: set tabstop=4 shiftwidth=4 expandtab: */<br /><br /><p>模式行有好几种形式。本文只介绍上面的这种形式（其它形式类似，请自行参考“:help modeline”）：行首的“/*”和尾部的“*/”告诉 C 编译器这是一行注释，不是代码的一部分；而 Vim 可通过后面的“vim:”识别出模式行的开始（必须出现在行首或前面有一个空白字符）；后面则是“set”和空格间隔开的一串 Vim 选项；“:”表示模式行结束。</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>Vim 里使用“/模式”（或“?模式”）进行搜索，使用“:s/模式/字符串/标志”进行替换</p><p>搜索里最最有用的一个快捷方式是“*”（向下完整匹配光标下的单词）</p><p>相似的技巧还有“#”（向上完整匹配光标下的单词）、“g*”（向下部分匹配光标下的单词）等，请自行查看（“:help #”等）。</p><p>再看几个搜索替换的实用例子。</p><ul><li>去掉所有的行尾空格：“:%s/\s\+$//”。“%”表示在整个文件范围内进行替换，“\s”表示空白字符（空格和制表符），“\+”对前面的字符匹配一次或多次（越多越好），“$”匹配行尾（使用“\$”表示单纯的“$”字符）；被替换的内容为空；由于一行最多只需替换一次，不需要特殊标志。这个还是比较简单的。</li><li>去掉所有的空白行：“:%s/\(\s*\n\)\+/\r/”。这回多了“\(”、“\)”、“\n”、“\r”和“*”。“*”代表对前面的字符（此处为“\s”）匹配零次或多次（越多越好；使用“\*”表示单纯的“*”字符），“\n”代表换行符，“\r”代表回车符，“\(”和“\)”对表达式进行分组，使其被视作一个不可分割的整体。因此，这个表达式的完整意义是，把连续的换行符（包含换行符前面可能有的连续空白字符）替换成为一个单个的换行符。唯一很特殊的地方是，在模式中使用的是“\n”，而被替换的内容中却不能使用“\n”，而只能使用“\r”。原因是历史造成的，详情如果有兴趣的话可以查看“:help NL-used-for-Nul”。</li><li>去掉所有的“//”注释：“:%s!\s*//.*!!”。首先可以注意到，这儿分隔符改用了“!”，原因是在模式或字符串部分使用了“/”字符，不换用其他分隔符的话就得在每次使用“/”字符本身时写成“\/”，上面的命令得写成“:%s/\s*\/\/.*//”，可读性较低。命令本身倒是相当简单，用过正则表达式的人估计都知道“.”匹配表示除换行符之外的任何字符吧。</li><li>去掉所有的“/* */”注释：“:%s!\s*/\*\_.\{-}\*/\s*! !g”。这个略有点复杂了，用到了几个不太常用的 Vim 正则表达式特性。“\_.”匹配包含换行在内的所有字符；“\{-}”表示前一个字符可出现零次或多次，但在整个正则表达式可以匹配成功的前提下，匹配的字符数越少越好；标志“g”表示一行里可以匹配和替换多次。替换的结果是个空格的目的是保证像“int/* space not necessary around comments */main()”这样的表达式在替换之后仍然是合法的。</li></ul>    <p>希望上面的这些简单的例子能够引起你使用 Vim 的正则表达式高效完成任务的兴趣。进一步的信息可参考“:help regexp”。</p><p>&nbsp;</p><p>&nbsp;</p><p>你只需要键入“aL”，然后按下“Ctrl-P”（向前搜索可匹配的单词并完成）就可以得到完整的变量名（没有得到想要的结果的话，多按几下“Ctrl-P”；或者前面多输入几个字符，如“aLongV”）。类似的命令还有“Ctrl-N”（向后搜索可匹配的单词并完成）、“Ctrl-X Ctrl-L”（搜索可匹配的行并完成）、“Ctrl-X Ctrl-F”（搜索可匹配的文件名并完成）等，具体可参看“:help ins-completion”。</p><p>&nbsp;</p><p>&nbsp;</p><p>可以使用“gf”命令方便地跳转到光标下的文件名所代表的文件中。在上面的例子中，把光标移到“stdio.h”的任一字符上，键入“gf”，则 Vim 会自动打开 /usr/include/stdio.h 文件。使用“Ctrl-O”（参见“:help CTRL-O”）可返回到原先的文件中。</p><p>&nbsp;</p><p>我们只需在项目的根目录处键入“ctags -R .”，Ctags 即可自动在文件中查找、识别支持的文件格式、生成 tags 文件。目前 Exuberant Ctags 支持多达 33 种编程语言 [16]，包括了 Linux 下常用的 C、C++、Java、Perl、PHP 等。有了 tags 文件，以下的 Vim 命令就可以方便使用了（进一步的信息可参考“:help tags-and-searches”）：</p><ul><li>:tag 关键字（跳转到与“关键字”匹配的标记处）</li><li>:tselect [关键字]（显示与“关键字”匹配的标记列表，输入数字跳转到指定的标记）</li><li>:tjump [关键字]（类似于“:tselect”，但当匹配项只有一个时直接跳转至标记处而不再显示列表）</li><li>:tn（跳转到下一个匹配的标记处）</li><li>:tp（跳转到上一个匹配的标记处）</li><li>Ctrl-]（跳转到与光标下的关键字匹配的标记处；除“关键字”直接从光标位置自动获得外，功能与“:tags”相同）</li><li>g]（与“Ctrl-]”功能类似，但使用的命令是“:tselect”）</li><li>g Ctrl-]（与“Ctrl-]”功能类似，但使用的命令是“:tjump”）</li><li>Ctrl-T（跳转回上次使用以上命令跳转前的位置）</li></ul>直接在 Vim 的命令模式里输入相应的 make 或 grep 命令（如“:grep foo *.c”）即可将命令的执行结果放入该窗口，同时根据返回的结果跳转到第一个错误（make 的情况；在使用 grep 时是匹配成功之处）。以下是常用的“快速修订”命令：<ul><li>:cn（显示下一个错误）</li><li>:cp（显示上一个错误）</li><li>:cl（列出所有的错误及其编号）</li><li>:cc（跳转到指定编号的错误）</li><li>:copen（打开快速修订窗口，在其中显示所有错误，可在错误上双击鼠标或按回车键跳转至该错误；示例参见图 4）</li></ul><p>&nbsp;</p><p>最正规的执行外部命令的方法，如前所述，就是“:!”。如果想把外部命令执行的结果插入到当前编辑的缓冲区中，可以考虑使用“:r!”。比如，我们使用“:r!ls”，就可以把“ls”命令的执行结果插入到缓冲区中光标所在行下面。</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>也许你会觉得这些很有用：</p><ul><li>%（跳转到与之匹配的括号处）</li><li>.（重复上次的修改命令）</li><li>`.（跳转到最近修改过的位置）</li><li>ZQ（无条件退出）</li><li>ZZ（存盘退出）</li><li>ga（显示光标下的字符在当前使用的 encoding 下的内码）</li><li>guw（光标下的单词变为小写）</li><li>gUw（光标下的单词变为大写）</li><li>:TOhtml（根据 Vim 的语法加亮的方式生成 HTML 代码；在图形界面中也可以使用菜单“Syntax—Convert to HTML”达到同样效果）</li></ul><p>无聊的时候，还可以试试（呵呵！）：</p><ul><li>:help!</li><li>:help 42</li><li>:help holy-grail</li></ul> </div>

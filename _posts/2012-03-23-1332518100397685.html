---
layout: post
title: 默认安装的vsftpd取消开机启动
time: 2012-03-23 23:55
keywords: 好好学习天天向上
---
<div id=content class="content mod-cs-content text-content clearfix"> <p>Linux Linux 3.2.0-17-generic #27-Ubuntu SMP Fri Feb 24 15:38:36 UTC 2012 i686 i686 i386 GNU/Linux</p><p>vsftpd: version 2.3.5</p><p>root@Linux:/etc# which vsftpd<br />/usr/sbin/vsftpd</p><p>root@Linux:/etc# whereis vsftpd<br />vsftpd: /usr/sbin/vsftpd /etc/vsftpd.conf /usr/share/man/man8/vsftpd.8.gz</p><p>root@Linux:~# ll /etc/init.d/vsftpd <br />lrwxrwxrwx 1 root root 21 Jan 23 22:25 /etc/init.d/vsftpd -&gt; /lib/init/upstart-job*</p><p>&nbsp;</p><p>&nbsp;</p><p>ok，找到一个软链接？先看看upstart介绍</p><p>Upstart is an event-based replacement for the /sbin/init daemonwhich handles starting of tasks and services during boot, stopping themduring shutdown and supervising them while the system is running.</p><p>It was originally developed for the <a href="http://www.ubuntu.com/">Ubuntu</a>distribution, but is intended to be suitable for deployment in allLinux distributions as a replacement for the venerable System-V init. </p><p>&nbsp;</p><p>ubuntu的upstart的体系下，/etc/init.d里面基本上都是连接到/lib/init/upstart-job的软连接，所以，对 initscripts的请求全部转化为upstart事件，upstart系统对启动项目的管理全部根据/etc/init里面的配置文件来启动，以gdm.conf为例，可以启动gdm的事件就让人咂舌</p><p>start on (filesystem<br />and started dbus<br />and (graphics-device-added fb0 PRIMARY_DEVICE_FOR_DISPLAY=1<br />or drm-device-added card0 PRIMARY_DEVICE_FOR_DISPLAY=1<br />or stopped udevtrigger))</p><p>stop on runlevel [016]</p><p>可见，一旦发生文件系统初始化，DBUS总线启动和发生graphics-device-added fb0 PRIMARY_DEVICE_FOR_DISPLAY=1 or drm-device-added card0 PRIMARY_DEVICE_FOR_DISPLAY=1 or stopped udevtrigger 这里面的任何一个事件，GDM就会被启动，只在运行级别在016的时候，GDM不启动。<br />所以，事件也就明了了、要在upstart层面干掉gdm，把上面的启动相关事件注释掉，改写下就行了</p><p>start on (filesystem<br />and started dbus<br />and (graphics-device-added fb0 PRIMARY_DEVICE_FOR_DISPLAY=1<br />or drm-device-added card0 PRIMARY_DEVICE_FOR_DISPLAY=1<br />or stopped udevtrigger)<br />and runlevel [245])<br />stop on runlevel [0136]</p><p>所以，<br />就算你清空整个rc3.d，upstart根本不管你。</p><p>如此这般，sysv-rc-conf， update-rc.d，rcconf，这三大神器，似乎就和残废了一样了</p><p>网上什么用sysv-rc-conf配置，什么改S开头为K开头什么的方法通通的不管用，因为10.04把MySql的启动连接到了/lib/init/upstart-job，而后者是调用了/etc/init/mysql.conf文件里面关于开机的定义，这是新的框架，所以以前的方法通通不管用了，你用sysv-rc-conf的时候甚至发现mysql更本禁止在任何runrevel上启动的，而实际情况是，它每次都很淡定地自动启动了</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>ok，转入正题</p><p>root@Linux:~# cat /etc/init/vsftpd.conf <br /><strong># vsftpd - FTP Daemon<br />#<br /><br />description&nbsp;&nbsp;&nbsp; &quot;vsftpd daemon&quot;<br />author&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &quot;Chuck Short &lt;zulcss@ubuntu.com&gt;&quot;<br /><br />start on runlevel [2345] or net-device-up IFACE!=lo<br />stop on runlevel [!2345]<br />respawn<br /><br />pre-start script<br />&nbsp;&nbsp;&nbsp; check_standalone_mode()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; # Return 1 if vsftpd.conf doesn't have listen yes or listen_ipv6=yes<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; CONFFILE=&quot;/etc/vsftpd.conf&quot;<br /><br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if [ -e&nbsp; &quot;${CONFFILE}&quot; ] &amp;&amp; ! egrep -iq &quot;^ *listen(_ipv6)? *= *yes&quot; &quot;${CONFFILE}&quot;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; then<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; echo &quot;${CONFFILE}: listen disabled - service will not start&quot;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return 1<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; fi<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; [ -d /var/run/vsftpd ] || install -m 755 -o root -g root -d /var/run/vsftpd<br />&nbsp;&nbsp;&nbsp; [ -d /var/run/vsftpd/empty ] || install -m 755 -o root -g root -d /var/run/vsftpd/empty<br />&nbsp;&nbsp;&nbsp; check_standalone_mode || stop<br />end script<br /><br />exec /usr/sbin/vsftpd<br />修改为</strong></p><p><strong>stop on runlevel [2345] or net-device-up IFACE!=lo<br />start on runlevel [!2345]<br /></strong></p><p>&nbsp;</p> </div>
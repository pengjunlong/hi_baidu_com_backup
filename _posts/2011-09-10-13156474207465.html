---
layout: post
title: flowvisor源代码分析修改-1
time: 2011-09-10 17:37
keywords: 好好学习天天向上
---
<div id=content class="content mod-cs-content text-content clearfix"> <p>ko@nox:~/flowvisor/src$ svn diff<br />Index: org/flowvisor/mysql/Mysql.java<br />===================================================================<br />--- org/flowvisor/mysql/Mysql.java&nbsp;&nbsp;&nbsp; (revision 0)<br />+++ org/flowvisor/mysql/Mysql.java&nbsp;&nbsp;&nbsp; (revision 0)<br />@@ -0,0 +1,39 @@<br />+package org.flowvisor.mysql;<br />+import java.sql.*;<br />+<br />+public class Mysql {<br />+&nbsp;&nbsp;&nbsp; private static Statement stmt;<br />+&nbsp;&nbsp;&nbsp; private static Connection con;<br />+&nbsp;&nbsp;&nbsp; private static String url = &quot;jdbc:mysql://localhost:3306/flowvisor&quot;;<br />+<br />+&nbsp;&nbsp;&nbsp; public static Connection mysql_open() {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; try {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Class.forName(&quot;com.mysql.jdbc.Driver&quot;);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; con = DriverManager.getConnection(url, &quot;root&quot;, &quot;&quot;);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } catch(Exception e) {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; e.printStackTrace();<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return con;<br />+&nbsp;&nbsp;&nbsp; }<br />+<br />+&nbsp;&nbsp;&nbsp; public static void mysql_close(Connection con) {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; try {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; con.close();<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } catch (Exception e) {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; e.printStackTrace();<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />+&nbsp;&nbsp;&nbsp; }<br />+<br />+&nbsp;&nbsp;&nbsp; public static Statement mysql_query(Connection con, int result_set) {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; try {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (result_set == 0)<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; stmt = con.createStatement();<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (result_set == 1)<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; stmt = con.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ResultSet.CONCUR_READ_ONLY);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } catch (Exception e) {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; e.printStackTrace();<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return stmt;<br />+&nbsp;&nbsp;&nbsp; }<br />+}<br />Index: org/flowvisor/ofswitch/TopologyController.java<br />===================================================================<br />--- org/flowvisor/ofswitch/TopologyController.java&nbsp;&nbsp;&nbsp; (revision 1)<br />+++ org/flowvisor/ofswitch/TopologyController.java&nbsp;&nbsp;&nbsp; (working copy)<br />@@ -3,6 +3,7 @@<br />&nbsp; */<br />&nbsp;package org.flowvisor.ofswitch;<br />&nbsp;<br />+import java.sql.*;<br />&nbsp;import java.io.IOException;<br />&nbsp;import java.nio.channels.SocketChannel;<br />&nbsp;import java.util.ArrayList;<br />@@ -27,6 +28,7 @@<br />&nbsp;import org.flowvisor.log.FVLog;<br />&nbsp;import org.flowvisor.log.LogLevel;<br />&nbsp;import org.json.JSONParam;<br />+import org.flowvisor.mysql.Mysql;<br />&nbsp;<br />&nbsp;/**<br />&nbsp; * A simple OpenFlow controller that runs inside the flowvisor to discover and<br />@@ -283,7 +285,16 @@<br />&nbsp;&nbsp;&nbsp;&nbsp; public synchronized void reportProbe(LinkAdvertisement linkAdvertisement) {<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (!this.latestProbes.containsKey(linkAdvertisement)) {<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; this.doCallback = true;<br />-&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; FVLog.log(LogLevel.INFO, this, &quot;adding link &quot; + linkAdvertisement);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; FVLog.log(LogLevel.INFO, this, &quot;pjl:adding link &quot; + linkAdvertisement);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; try {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Connection con = Mysql.mysql_open();<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Statement stmt = Mysql.mysql_query(con, 0);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; stmt.executeUpdate(&quot;create table if not exists adding_link(info varchar(666))&quot;);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; stmt.executeUpdate(&quot;insert into adding_link values('&quot; + linkAdvertisement + &quot;')&quot;);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Mysql.mysql_close(con);<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } catch (Exception e) {<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; e.printStackTrace();<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; this.latestProbes.put(linkAdvertisement, Long.valueOf(System<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; .currentTimeMillis()));<br />Index: org/flowvisor/api/FVCtl.java<br />===================================================================<br />--- org/flowvisor/api/FVCtl.java&nbsp;&nbsp;&nbsp; (revision 1)<br />+++ org/flowvisor/api/FVCtl.java&nbsp;&nbsp;&nbsp; (working copy)<br />@@ -700,7 +700,8 @@<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; String URL = &quot;https://localhost:8080/xmlrpc&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; String JETTY_URL = &quot;https://localhost:8081/flowvisor&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; String user = FVConfig.SUPER_USER;<br />-&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; String passwd = null;<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; String passwd = &quot;ok&quot;;<br />+&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; //pjl:String passwd = null;<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; boolean debug = false;<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; boolean jetty = false;<br />&nbsp;<br />Index: org/flowvisor/api/LinkAdvertisement.java<br />===================================================================<br />--- org/flowvisor/api/LinkAdvertisement.java&nbsp;&nbsp;&nbsp; (revision 1)<br />+++ org/flowvisor/api/LinkAdvertisement.java&nbsp;&nbsp;&nbsp; (working copy)<br />@@ -145,6 +145,7 @@<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;* (non-Javadoc)<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;*<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;* @see java.lang.Object#toString()<br />+&nbsp;&nbsp;&nbsp; &nbsp;* pjl:link add remove <br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp; @Override<br />&nbsp;&nbsp;&nbsp;&nbsp; public String toString() {</p> </div>
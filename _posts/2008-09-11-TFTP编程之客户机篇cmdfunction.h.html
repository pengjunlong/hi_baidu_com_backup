<h2></h2><br/><h1>TFTP编程之客户机篇cmdfunction.h</h1><hr/>
<div id=content class="content mod-cs-content text-content clearfix"> <p>/***************************************************************/<br />/*声明回调函数*/<br />#include &lt;stdio.h&gt;<br />#include &lt;winsock.h&gt;</p><p>#include &quot;makepack.h&quot;</p><p>typedef void (* CMDFUNC)(char [][256],int pcount);</p><p>typedef struct _cmdnum{<br /> char *cmd;&nbsp;&nbsp;&nbsp; /*命令代码*/<br /> int num;&nbsp;&nbsp;&nbsp; /*序号*/<br /> int paramcount;&nbsp;&nbsp; /*参数个数*/<br /> CMDFUNC callback; /*回调函数名*/<br />}CMDNUM,*PCMDNUM;</p><p>/*定义帮助文档*/<br />/************************************************************/<br />char *helptext = &quot;help:&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp; show this text\n\<br />link dest_ip:&nbsp;&nbsp; connect to server\n\<br />exit:&nbsp;&nbsp;&nbsp;&nbsp; exit pragram\n\<br />get filename:&nbsp;&nbsp;&nbsp; get file from server\n\<br />put local_fname dest_fname: upload file to server\n&quot;;<br />/*************************************************************/</p><p>extern char desthost[256];<br />extern SOCKET sock;<br />extern int  filemode;</p><p>void showhelp (char cmd[][256],int pcount); /*显示帮助信息*/<br />void connectto (char cmd[][256],int pcount); /*连接目的主机*/<br />void quit&nbsp;&nbsp; (char cmd[][256],int pcount); /*退出*/<br />void getfile (char cmd[][256],int pcount); /*下载文件*/<br />void putfile (char cmd[][256],int pcount); /*上传文件*/<br />int login(struct sockaddr_in sour_addr);<br />/**************************************************************/</p><p>/*提供帮助信息*/<br />void showhelp(char cmd[][256],int pcount)<br />{<br /> printf(helptext);<br />}</p><p>/*设置目的主机地址*/<br />void connectto(char cmd[][256],int pcount)<br />{<br /> if(pcount&lt;1){<br />&nbsp;&nbsp; printf(&quot;usage: link remoteip \n&quot;);<br />&nbsp;&nbsp; return;<br /> }<br /> strcpy(desthost,cmd[1]);<br />}</p><p>/*退出*/<br />void quit(char cmd[][256],int pcount)<br />{<br /> printf(&quot;exit to system \n&quot;);<br /> closesocket(sock);<br /> exit(0);<br />}</p><p>int login(struct sockaddr_in sour_addr)<br />{<br /> char sendbuf[20];<br /> char recvbuf[20];<br /> memset(sendbuf,'\0',sizeof(sendbuf));<br /> memset(recvbuf,'\0',sizeof(recvbuf));<br /> <br /> int sour_len = sizeof(sockaddr);<br /> <br /> recvfrom(sock,recvbuf,sizeof(recvbuf),0,(sockaddr *)&amp;sour_addr,&amp;sour_len);<br /> printf(recvbuf);<br /> gets(sendbuf);<br /> sendto(sock,sendbuf,sizeof(sendbuf),0,(sockaddr *)&amp;sour_addr,sizeof(sour_addr));<br /> recvfrom(sock,recvbuf,sizeof(recvbuf),0,(sockaddr *)&amp;sour_addr,&amp;sour_len);<br /> if(strcmp(recvbuf,&quot;用户名正确!!!\n&quot;)==0)<br /> {<br />&nbsp;&nbsp; printf(recvbuf);<br />&nbsp;&nbsp; return 1;<br /> }<br /> else<br /> {<br />&nbsp;&nbsp; printf(recvbuf);<br />&nbsp;&nbsp; return 0;</p><p> }<br />}</p><p>/*下载文件*/<br />void getfile(char cmd[][256],int pcount)<br />{<br /> int pass;<br /> char send_buffer[1024] = {0};<br /> char recv_buffer[1024] = {0};<br /> sockaddr_in sour_addr;<br /> </p><p> struct  timeval timeout = {10,0};<br /> int sour_len = 0;<br /> int ret = 0;<br /> int len = 0 ;<br /> int retry = 0;<br /> int flen = 0;<br /> int stat = 0;<br /> unsigned short lastdata = 0;<br /> unsigned short blocknum=1;<br /> fd_set  fdr;<br />&nbsp;&nbsp;<br /> FILE *file;<br /> <br /> int c;<br /> <br /> if(pcount!=1){&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /*输入的参数个数不合要求*/<br />&nbsp;&nbsp; printf(&quot;usage: get filename\n&quot;);<br />&nbsp;&nbsp; return;<br /> }</p><p> if((file=fopen(cmd[1],&quot;rb&quot;))!=NULL){<br />&nbsp;&nbsp; printf(&quot;File %s already exits,overwrite? y/n &quot;,cmd[1]);<br />&nbsp;&nbsp; while(true){<br />&nbsp;&nbsp;&nbsp; c = getch();<br />&nbsp;&nbsp;&nbsp; if('y'==c || 'Y'==toupper(c)){<br />&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp; if('n'==c || 'N'==toupper(c)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp; }<br /> }<br /> if((file=fopen(cmd[1],&quot;w+b&quot;))==NULL){<br />&nbsp;&nbsp; printf(&quot;Can't create file\n&quot;);<br />&nbsp;&nbsp; return;<br /> }<br /> len = makereq(TFTP_RRQ,filemode,cmd[1],send_buffer,sizeof(send_buffer));</p><p> sour_addr.sin_family =AF_INET;<br /> sour_addr.sin_family =AF_INET;<br /> sour_addr.sin_port = htons(69);<br /> sour_addr.sin_addr.s_addr = inet_addr(desthost);</p><p> ret = sendto(sock,send_buffer,len,0,(sockaddr *)&amp;sour_addr,sizeof(sour_addr));<br /> pass=login(sour_addr);<br /> while(true&amp;&amp;pass==1){<br />&nbsp;&nbsp; FD_ZERO(&amp;fdr);<br />&nbsp;&nbsp; FD_SET(sock, &amp;fdr);</p><p>&nbsp;&nbsp; ret = select(sock, &amp;fdr, NULL,NULL, &amp;timeout);//?<br />&nbsp;&nbsp;<br />&nbsp;&nbsp; if(SOCKET_ERROR==ret){&nbsp;&nbsp; /*#define SOCKET_ERROR&nbsp;&nbsp;  (-1)*/<br />&nbsp;&nbsp;&nbsp; printf(&quot;Socket error \n&quot;);<br />&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp; }<br />&nbsp;&nbsp; else{ <br />&nbsp;&nbsp;&nbsp; if(0==ret){<br />&nbsp;&nbsp;&nbsp;&nbsp; if(MAX_RETRY==retry){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Time Out \n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp; sendto(sock,send_buffer,len,0,(sockaddr *)&amp;sour_addr,sizeof(sour_addr));<br />&nbsp;&nbsp;&nbsp;&nbsp; retry++;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp;&nbsp; if (FD_ISSET(sock,&amp;fdr)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; retry = 0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sour_len = sizeof(sockaddr);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = recvfrom(sock,recv_buffer,sizeof(recv_buffer),0,(sockaddr *)&amp;sour_addr,&amp;sour_len);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(TFTP_ERROR==recv_buffer[1]){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(recv_buffer[3]){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Not_defined:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Not defined\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case File_not_found:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;File not found\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Access_violation:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Access violation\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Disk_full:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Disk full\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Illegal_TFTP_operation:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Illegal TFTP operation\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Unknown_port:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Unknown port\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case File_already_exists:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;file already exists\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case No_such_user:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;No such user\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Time_out:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Time out\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Read_file_Error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Read file error\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Cannot_create_file:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Can't create file\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default :<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;unknown error\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(0==stat){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sour_addr.sin_port = sour_addr.sin_port ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stat = 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(TFTP_DATA==recv_buffer[1]){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lastdata = MAKEWORD(recv_buffer[2],recv_buffer[3]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; len = makeack(lastdata,send_buffer,sizeof(send_buffer));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sendto(sock,send_buffer,len,0,(sockaddr *)&amp;sour_addr,sizeof(sour_addr));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(blocknum &gt; 65535)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blocknum = 0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(blocknum!=MAKEWORD(recv_buffer[3],recv_buffer[2]))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {printf(&quot;收到重复的数据#DATA%d!!!ACK\n&quot;,blocknum-1);}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ret &lt; TFTP_NOTEND_DATALEN){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fwrite(&amp;recv_buffer[4],1,ret-4,file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flen = flen + ret -4;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if((ret-4)!=0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;#DATA%d:%d byte,共收到%d byte\n&quot;,blocknum,ret-4,flen);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;\n传输结束\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;total %d byte received\n&quot;,flen);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fwrite(&amp;recv_buffer[4],1,512,file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flen = flen + 512;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;#DATA%d:512 byte,共收到%d byte\n&quot;,blocknum,flen);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blocknum++;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp; }<br /> }<br />}</p><p><br />void putfile(char cmd[][256],int pcount)<br />{<br /> int pass;<br /> char send_buffer[1024] = {0};<br /> char recv_buffer[1024] = {0};<br /> char data_buffer[1024] = {0};<br /> sockaddr_in sour_addr;<br /> </p><p> int retry = 0;<br /> int sour_len = 0;<br /> int ret = 0;<br /> int len = 0;<br /> int flen = 0;</p><p> fd_set  fdr;<br /> <br /> struct  timeval timeout = {10,0};<br /> int stat = TFTP_WSTAT_FIRSTACK;</p><p> unsigned short lastack = 0;<br /> unsigned short blocknum = 0;</p><p> FILE *file;<br /> size_t rlen = 0;</p><p> if(pcount!=2){<br />&nbsp;&nbsp; printf(&quot;usage: put localfilename remotefilename \n&quot;);<br />&nbsp;&nbsp; return;<br /> }</p><p> if((file=fopen(cmd[1],&quot;rb&quot;))==NULL){<br />&nbsp;&nbsp; printf(&quot;File %s not found \n&quot;,cmd[1]);<br />&nbsp;&nbsp; return;<br /> }</p><p> len = makereq(TFTP_WRQ,filemode,cmd[2],send_buffer,sizeof(send_buffer));<br /> <br /> sour_addr.sin_family =AF_INET;<br /> sour_addr.sin_family =AF_INET;<br /> sour_addr.sin_port = htons(69);<br /> sour_addr.sin_addr.s_addr = inet_addr(desthost);</p><p> ret = sendto(sock,send_buffer,len,0,(sockaddr *)&amp;sour_addr,sizeof(sour_addr));<br /> //printf(&quot;%d&quot;,ret);<br /> if((file=fopen(cmd[1],&quot;rb&quot;))==NULL){<br />&nbsp;&nbsp; printf(&quot;Can't Open file %s\n&quot;,cmd[1]);<br />&nbsp;&nbsp; return;<br /> }<br /> pass=login(sour_addr);<br /> while(true&amp;&amp;pass==1){<br />&nbsp;&nbsp; FD_ZERO(&amp;fdr);<br />&nbsp;&nbsp; FD_SET(sock, &amp;fdr);<br />&nbsp;&nbsp; ret = select(sock, &amp;fdr, NULL,NULL, &amp;timeout);<br />&nbsp;&nbsp; //printf(&quot;%d&quot;,ret);<br />&nbsp;&nbsp; if(SOCKET_ERROR==ret){<br />&nbsp;&nbsp;&nbsp; printf(&quot;Socket error \n&quot;);<br />&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp; }<br />&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp; if(0==ret){<br />&nbsp;&nbsp;&nbsp;&nbsp; if(MAX_RETRY==retry){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Time Out \n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp; sendto(sock,send_buffer,len,0,(sockaddr *)&amp;sour_addr,sizeof(sour_addr));<br />&nbsp;&nbsp;&nbsp;&nbsp; retry++;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp; retry = 0;<br />&nbsp;&nbsp;&nbsp;&nbsp; sour_len = sizeof(sockaddr);<br />&nbsp;&nbsp;&nbsp;&nbsp; ret = recvfrom(sock,recv_buffer,sizeof(recv_buffer),0,(sockaddr *)&amp;sour_addr,&amp;sour_len);<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp; if(TFTP_ERROR==recv_buffer[1]){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(recv_buffer[3]){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Not_defined:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Not defined\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case File_not_found:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;File not found\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Access_violation:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Access violation\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Disk_full:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Disk full\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Illegal_TFTP_operation:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Illegal TFTP operation\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Unknown_port:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Unknown port\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case File_already_exists:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;file already exists\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case No_such_user:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;No such user\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Time_out:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Time out\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Read_file_Error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Read file error\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case Cannot_create_file:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Can't create file\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default :<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;unknown error\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//end switch<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp; if(TFTP_ACK==recv_buffer[1]){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lastack = MAKEWORD(recv_buffer[3],recv_buffer[2]);</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch(stat){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case TFTP_WSTAT_FIRSTACK:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(0==lastack){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stat = TFTP_WSTAT_NEXTACK;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sour_addr.sin_port = sour_addr.sin_port ;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rlen = fread(data_buffer,1,512,file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flen = flen + rlen;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(rlen&lt;512 &amp;&amp; feof(file)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stat = TFTP_WSTAT_LASTACK;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ferror(file)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Error: read file\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blocknum++;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(blocknum &gt; 65535)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blocknum = 0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; len = makedata(blocknum,data_buffer,rlen,send_buffer,sizeof(send_buffer));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sendto(sock,send_buffer,len,0,(sockaddr *)&amp;sour_addr,sizeof(sour_addr));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(rlen!=0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;%d byte send,共发送%d byte\n&quot;,rlen,flen);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Error Ack Number\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case TFTP_WSTAT_NEXTACK:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(lastack==blocknum){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rlen = fread(data_buffer,1,512,file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flen = flen + rlen;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(rlen&lt;512 &amp;&amp; feof(file)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stat = TFTP_WSTAT_LASTACK;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ferror(file)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Error: read file\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blocknum++;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(blocknum &gt; 65535)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blocknum = 0;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; len = makedata(blocknum,data_buffer,rlen,send_buffer,sizeof(send_buffer));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sendto(sock,send_buffer,len,0,(sockaddr *)&amp;sour_addr,sizeof(sour_addr));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(rlen!=0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;%d byte send,共发送%d byte\n&quot;,rlen,flen);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Error Ack Number\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case TFTP_WSTAT_LASTACK:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(lastack==blocknum){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;\n传输结束\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;total %d byte send\n&quot;,flen);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fclose(file);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf(&quot;Error Ack Number\n&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//end switch<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp; }<br /> }<br />}</p> </div>